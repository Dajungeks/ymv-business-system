# YMV Business System v4.0 - 객관적 현재 상태 문서

## 기본 정보

**프로젝트**: YMV 관리 프로그램  
**위치**: D:\ymv-business-system  
**기술 스택**: Python + Streamlit + Supabase PostgreSQL  
**배포**: https://ymv-business-system.streamlit.app  
**최종 배포**: 2025-09-23  
**Git 상태**: 최신 코드 푸시 완료

## 실제 진행된 작업들

### Step 1: 데이터베이스 스키마 수정
**실행한 SQL 스크립트**: `upgrade_v4.sql`
```sql
ALTER TABLE expenses ADD COLUMN IF NOT EXISTS purpose TEXT;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS business_type VARCHAR(100);
ALTER TABLE company_info ADD COLUMN IF NOT EXISTS business_number VARCHAR(50);
ALTER TABLE products ADD COLUMN IF NOT EXISTS product_name_en VARCHAR(200);
ALTER TABLE products ADD COLUMN IF NOT EXISTS product_name_vn VARCHAR(200);
ALTER TABLE products ADD COLUMN IF NOT EXISTS code_category VARCHAR(50);
ALTER TABLE products ADD COLUMN IF NOT EXISTS display_category VARCHAR(100);
```
**결과**: 테이블별 행 수 확인됨 (expenses: 0, customers: 1, company_info: 1, products: 2, product_codes: 1)

### Step 2-3: Widget 중복 오류 수정 및 컴포넌트 생성
**생성한 파일들**:
1. `D:\ymv-business-system\app\components\__init__.py` - 패키지 초기화
2. `D:\ymv-business-system\app\components\code_management.py` - 코드 관리 컴포넌트
3. `D:\ymv-business-system\app\components\multilingual_input.py` - 다국어 입력 컴포넌트

**해결한 문제**: DuplicateWidgetID 오류 → `generate_unique_key()` 함수 도입

### Step 4: 메뉴 네비게이션 수정
**변경 내용**: `st.selectbox` → `st.button` 기반 메뉴로 변경
**추가한 세션 상태**: `st.session_state.current_menu`
**결과**: 메뉴 클릭 시 즉시 페이지 변경 작동 확인됨

### Step 5: 지출 요청서 기능 구현

#### Step 5-1: 추가 스키마 수정
**발견된 문제**: expenses 테이블에 vendor, expense_type 등 컬럼 누락
**실행한 SQL**:
```sql
ALTER TABLE expenses ADD COLUMN IF NOT EXISTS vendor VARCHAR(200);
ALTER TABLE expenses ADD COLUMN IF NOT EXISTS expense_type VARCHAR(100);
ALTER TABLE expenses ADD COLUMN IF NOT EXISTS expense_date DATE;
ALTER TABLE expenses ADD COLUMN IF NOT EXISTS payment_method VARCHAR(100);
ALTER TABLE expenses ADD COLUMN IF NOT EXISTS currency VARCHAR(10);
```
**확인 결과**: 총 25건의 expenses 데이터 존재 확인됨

#### Step 5-2: 지출 요청서 완전 기능 구현
**구현한 기능들**:
- 4개 탭 구성: 작성/목록/통계/CEO승인
- CEO 승인 워크플로우: 대기중 → CEO승인대기 → 승인됨 → 지급완료 → 인보이스 확인완료
- 월단위 상세 정보 표시
- CSV 다운로드 (BOM 포함으로 한글 깨짐 해결)
- 프린트 기능 (CSS @media print 적용)
- 완전한 CRUD: 생성/읽기/수정/삭제 모두 구현

## 현재 실제 작동하는 기능들

### 완전히 작동하는 기능
1. **로그인/로그아웃**
   - employees 테이블 기반 인증
   - Master/1023 계정으로 로그인 가능
   - 세션 상태 관리 (user_id, username, is_admin, logged_in)

2. **대시보드**
   - 실시간 통계 카드 4개
   - 빠른 통계 사이드바
   - v4.0 기능 소개 섹션

3. **지출 요청서 관리 (100% 작동)**
   - 지출 요청서 작성 폼
   - 월단위 그룹핑된 목록 표시
   - 인라인 수정 기능
   - 상태 변경 기능
   - 삭제 기능
   - 프린트 기능
   - CSV 다운로드 기능
   - CEO 승인 관리 (관리자만 접근)
   - 비용 통계 표시

4. **코드 관리 시스템**
   - 7단계 코드 등록 (CODE01-CODE07)
   - 실시간 미리보기 (HR-01-02-ST-KR-00 형식)
   - 코드 목록 및 관리
   - 수정/삭제/상태변경 기능

5. **메뉴 네비게이션**
   - 버튼 기반 메뉴 (8개 메뉴)
   - 세션 상태 기반 현재 메뉴 표시
   - 메뉴 클릭 시 즉시 페이지 전환

### 부분적으로만 작동하는 기능

1. **구매품 관리**
   - 등록 기능: 작동함
   - 목록 표시: 작동함
   - 수정/삭제: 기본적인 삭제만 작동, 수정 기능 미구현
   - 상태 변경: "곧 구현됩니다" 메시지만 표시

2. **권한 시스템**
   - 기본 로그인/로그아웃: 작동함
   - is_admin 필드: 존재함
   - 지출 요청서에서만 권한 구분 적용:
     * 일반 사용자: 대기중, CEO승인대기만 선택 가능
     * 관리자: 모든 상태 선택 가능
     * CEO 승인 탭: 관리자만 접근 가능
   - 기타 권한 관리: 미구현

### 작동하지 않는 기능들

1. **견적서 관리**
   - 메뉴 클릭 시: "견적서 관리 기능은 Step 6에서 구현됩니다." 메시지만 표시
   - 실제 기능: 없음

2. **고객 관리**  
   - 메뉴 클릭 시: "고객 관리 기능은 Step 7에서 구현됩니다." 메시지만 표시
   - 실제 기능: 없음

3. **제품 관리**
   - 메뉴 클릭 시: "제품 관리 기능은 Step 8에서 구현됩니다." 메시지만 표시
   - 실제 기능: 없음

4. **직원 관리**
   - 메뉴 클릭 시: "직원 관리 기능은 향후 구현됩니다." 메시지만 표시
   - 실제 기능: 없음

5. **시스템 관리**
   - 코드 관리: 완전히 작동함
   - 회사 정보 관리: 구현 상태 불명확
   - 환율 관리: 구현 상태 불명확

## 데이터베이스 현재 상태

### 확인된 테이블 구조
```sql
-- product_codes: 1건 데이터 (활성 상태)
-- expenses: 25건 데이터 (모든 필수 컬럼 존재 확인)
-- customers: 1건 데이터
-- company_info: 1건 데이터  
-- products: 2건 데이터
-- employees: 최소 1건 데이터 (Master 계정)
```

### 추가된 컬럼들 (Step 1, 5-1에서 확인됨)
- expenses: purpose, vendor, expense_type, expense_date, payment_method, currency
- customers: business_type
- company_info: business_number
- products: product_name_en, product_name_vn, code_category, display_category

## 실제 파일 구조

```
D:\ymv-business-system/
├── app/
│   ├── main.py                    # 1800+ lines, Step 5까지 기능 포함
│   └── components/                # Step 3에서 생성
│       ├── __init__.py           # 패키지 초기화
│       ├── code_management.py    # 코드 관리 컴포넌트 (작동 확인됨)
│       └── multilingual_input.py # 다국어 입력 컴포넌트
├── database/
│   ├── upgrade_v4.sql            # Step 1 실행됨
│   └── additional_schema_fix.sql # Step 5-1 실행됨
├── requirements.txt              # 업데이트됨
├── .streamlit/config.toml        # 설정 완료
└── .env                          # Supabase 연결 정보
```

## 해결된 구체적 문제들

### 1. 데이터베이스 스키마 불일치
**문제**: "Could not find the 'purpose' column of 'expenses'"
**해결**: ALTER TABLE로 누락 컬럼 추가
**확인**: 25건 데이터로 정상 작동 확인

### 2. Widget 키 중복
**문제**: DuplicateWidgetID 오류
**해결**: generate_unique_key() 함수 도입
**적용**: timestamp + UUID 조합으로 고유 키 생성

### 3. 메뉴 네비게이션 미작동
**문제**: selectbox 선택해도 페이지 변경 안됨
**해결**: button 기반 메뉴 + 세션 상태 관리
**확인**: 메뉴 클릭 시 즉시 페이지 전환 작동

### 4. CSV 한글 깨짐
**문제**: Excel에서 한글이 물음표로 표시
**해결**: BOM 헤더 추가 (\\ufeff + utf-8)
**적용**: create_csv_download() 함수에 구현

## 미해결 상태 또는 미구현 영역

### 1. 제품-코드 연동 로직
**현재 상태**: product_codes 테이블과 products 테이블이 분리된 상태
**미구현**: 제품 등록 시 코드 선택 기능 없음

### 2. 다국어 시스템 연동  
**현재 상태**: products 테이블에 다국어 컬럼 존재
**미구현**: 실제 다국어 입력/표시 시스템 연동 안됨

### 3. 견적서/고객/직원 관리 CRUD
**현재 상태**: 메뉴만 존재, 실제 기능 없음
**표시 메시지**: "Step X에서 구현됩니다"

### 4. 시스템 관리의 회사정보/환율 관리
**현재 상태**: 탭은 존재하지만 실제 작동 여부 미확인

## 권한 시스템의 실제 구현 범위

### 구현된 부분
- 로그인/로그아웃 기본 기능
- employees.is_admin 필드 존재 및 활용
- 지출 요청서에서만 권한 구분:
  * 관리자: CEO 승인 탭 접근 가능, 모든 상태 선택 가능
  * 일반 사용자: CEO 승인 탭 접근 불가, 제한된 상태만 선택 가능

### 미구현된 부분
- 세분화된 권한 레벨 (부서장, 팀장 등)
- 직원별 권한 부여/회수 기능
- 기능별 접근 권한 매트릭스
- 승인 권한자 계층 구조

## 다음 개발 단계에서 실제 구현해야 할 것들

### 즉시 구현 가능한 것들
1. 시스템 관리의 회사정보/환율 관리 기능 완성
2. 구매품 관리의 수정 기능 구현

### 연동 로직 구현이 필요한 것들  
1. 제품 관리와 코드 관리 연동
2. 제품 관리와 견적서 관리 연동
3. 다국어 입력 시스템 실제 활용

### 새로 구축해야 할 것들
1. 고객 관리 완전한 CRUD
2. 직원 관리 완전한 CRUD  
3. 견적서 관리 완전한 CRUD
4. 세분화된 권한 관리 시스템

## 배포 및 접근 정보

**웹 접근**: https://ymv-business-system.streamlit.app
**테스트 계정**: Master / 1023  
**권한**: 관리자 (모든 기능 접근 가능)
**Git 상태**: 모든 변경사항 푸시 완료 (2025-09-23)
**작동 확인**: 지출 요청서 관리 모든 기능 정상 작동

이 문서는 추측이나 계획이 아닌, 실제로 구현되고 테스트된 내용만을 기록한 객관적 현재 상태입니다.