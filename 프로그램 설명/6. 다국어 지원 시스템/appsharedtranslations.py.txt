"""
Multi-language support for YMV Business Management System
"""

import streamlit as st
from typing import Dict, Optional
from .database import db_manager

class TranslationManager:
    """Manage translations and language switching"""
    
    def __init__(self):
        self.supported_languages = {
            'ko': 'í•œêµ­ì–´',
            'en': 'English', 
            'vn': 'Tiáº¿ng Viá»‡t'
        }
        self.current_language = 'ko'
        self.translations_cache = {}
        self._load_translations()
    
    def _load_translations(self):
        """Load all translations from database"""
        try:
            query = "SELECT translation_key, language_code, translation_value FROM translations"
            results = db_manager.execute_query(query)
            
            for row in results:
                key = row['translation_key']
                lang = row['language_code']
                value = row['translation_value']
                
                if lang not in self.translations_cache:
                    self.translations_cache[lang] = {}
                
                self.translations_cache[lang][key] = value
                
        except Exception as e:
            # Use fallback translations if database is not available
            self._load_fallback_translations()
    
    def _load_fallback_translations(self):
        """Load fallback translations"""
        self.translations_cache = {
            'ko': {
                'login': 'ë¡œê·¸ì¸',
                'logout': 'ë¡œê·¸ì•„ì›ƒ', 
                'username': 'ì‚¬ìš©ìžëª…',
                'password': 'ë¹„ë°€ë²ˆí˜¸',
                'dashboard': 'ëŒ€ì‹œë³´ë“œ',
                'system': 'ì‹œìŠ¤í…œ ê´€ë¦¬',
                'general_affairs': 'ì´ë¬´',
                'sales': 'ì˜ì—… ê´€ë¦¬',
                'save': 'ì €ìž¥',
                'cancel': 'ì·¨ì†Œ',
                'edit': 'ìˆ˜ì •',
                'delete': 'ì‚­ì œ',
                'search': 'ê²€ìƒ‰',
                'add': 'ì¶”ê°€',
                'error': 'ì˜¤ë¥˜',
                'success': 'ì„±ê³µ',
                'warning': 'ê²½ê³ ',
                'info': 'ì •ë³´'
            },
            'en': {
                'login': 'Login',
                'logout': 'Logout',
                'username': 'Username', 
                'password': 'Password',
                'dashboard': 'Dashboard',
                'system': 'System Management',
                'general_affairs': 'General Affairs',
                'sales': 'Sales Management',
                'save': 'Save',
                'cancel': 'Cancel',
                'edit': 'Edit',
                'delete': 'Delete',
                'search': 'Search',
                'add': 'Add',
                'error': 'Error',
                'success': 'Success',
                'warning': 'Warning',
                'info': 'Information'
            },
            'vn': {
                'login': 'ÄÄƒng nháº­p',
                'logout': 'ÄÄƒng xuáº¥t',
                'username': 'TÃªn ngÆ°á»i dÃ¹ng',
                'password': 'Máº­t kháº©u', 
                'dashboard': 'Báº£ng Ä‘iá»u khiá»ƒn',
                'system': 'Quáº£n lÃ½ há»‡ thá»‘ng',
                'general_affairs': 'Tá»•ng vá»¥',
                'sales': 'Quáº£n lÃ½ bÃ¡n hÃ ng',
                'save': 'LÆ°u',
                'cancel': 'Há»§y',
                'edit': 'Chá»‰nh sá»­a',
                'delete': 'XÃ³a',
                'search': 'TÃ¬m kiáº¿m',
                'add': 'ThÃªm',
                'error': 'Lá»—i',
                'success': 'ThÃ nh cÃ´ng',
                'warning': 'Cáº£nh bÃ¡o',
                'info': 'ThÃ´ng tin'
            }
        }
    
    def set_language(self, language_code: str):
        """Set current language"""
        if language_code in self.supported_languages:
            self.current_language = language_code
            st.session_state.language = language_code
    
    def get_language(self) -> str:
        """Get current language"""
        return st.session_state.get('language', 'ko')
    
    def translate(self, key: str, language: str = None) -> str:
        """Get translation for key"""
        if language is None:
            language = self.get_language()
        
        # Check cache first
        if language in self.translations_cache:
            if key in self.translations_cache[language]:
                return self.translations_cache[language][key]
        
        # Fallback to English if key not found in current language
        if language != 'en' and 'en' in self.translations_cache:
            if key in self.translations_cache['en']:
                return self.translations_cache['en'][key]
        
        # Return key if no translation found
        return key
    
    def add_translation(self, key: str, translations: Dict[str, str], module: str = None):
        """Add new translation to database"""
        try:
            for language_code, translation_value in translations.items():
                if language_code in self.supported_languages:
                    query = """
                    INSERT INTO translations (translation_key, language_code, translation_value, module_name)
                    VALUES (%s, %s, %s, %s)
                    ON CONFLICT (translation_key, language_code) 
                    DO UPDATE SET translation_value = EXCLUDED.translation_value
                    """
                    
                    db_manager.execute_query(
                        query, 
                        (key, language_code, translation_value, module), 
                        fetch=False
                    )
                    
                    # Update cache
                    if language_code not in self.translations_cache:
                        self.translations_cache[language_code] = {}
                    self.translations_cache[language_code][key] = translation_value
                    
        except Exception as e:
            st.error(f"Failed to add translation: {e}")
    
    def get_language_selector(self, key: str = "language_selector") -> str:
        """Create language selector widget"""
        current_lang = self.get_language()
        
        selected_lang = st.selectbox(
            "ðŸŒ Language",
            options=list(self.supported_languages.keys()),
            format_func=lambda x: self.supported_languages[x],
            index=list(self.supported_languages.keys()).index(current_lang),
            key=key
        )
        
        if selected_lang != current_lang:
            self.set_language(selected_lang)
            st.rerun()
        
        return selected_lang

# Global translation manager instance
translation_manager = TranslationManager()

# Convenience function for translations
def t(key: str, language: str = None) -> str:
    """Translate key to current or specified language"""
    return translation_manager.translate(key, language)

def add_translations(translations_dict: Dict[str, Dict[str, str]], module: str = None):
    """Add multiple translations at once"""
    for key, translations in translations_dict.items():
        translation_manager.add_translation(key, translations, module)

# Pre-defined translation sets for common use cases
COMMON_TRANSLATIONS = {
    # Navigation
    'home': {'ko': 'í™ˆ', 'en': 'Home', 'vn': 'Trang chá»§'},
    'back': {'ko': 'ë’¤ë¡œ', 'en': 'Back', 'vn': 'Quay láº¡i'},
    'next': {'ko': 'ë‹¤ìŒ', 'en': 'Next', 'vn': 'Tiáº¿p theo'},
    'previous': {'ko': 'ì´ì „', 'en': 'Previous', 'vn': 'TrÆ°á»›c'},
    'menu': {'ko': 'ë©”ë‰´', 'en': 'Menu', 'vn': 'Menu'},
    
    # Actions
    'create': {'ko': 'ìƒì„±', 'en': 'Create', 'vn': 'Táº¡o'},
    'update': {'ko': 'ì—…ë°ì´íŠ¸', 'en': 'Update', 'vn': 'Cáº­p nháº­t'},
    'view': {'ko': 'ë³´ê¸°', 'en': 'View', 'vn': 'Xem'},
    'download': {'ko': 'ë‹¤ìš´ë¡œë“œ', 'en': 'Download', 'vn': 'Táº£i xuá»‘ng'},
    'upload': {'ko': 'ì—…ë¡œë“œ', 'en': 'Upload', 'vn': 'Táº£i lÃªn'},
    'export': {'ko': 'ë‚´ë³´ë‚´ê¸°', 'en': 'Export', 'vn': 'Xuáº¥t'},
    'import': {'ko': 'ê°€ì ¸ì˜¤ê¸°', 'en': 'Import', 'vn': 'Nháº­p'},
    'print': {'ko': 'ì¸ì‡„', 'en': 'Print', 'vn': 'In'},
    'send': {'ko': 'ì „ì†¡', 'en': 'Send', 'vn': 'Gá»­i'},
    'approve': {'ko': 'ìŠ¹ì¸', 'en': 'Approve', 'vn': 'PhÃª duyá»‡t'},
    'reject': {'ko': 'ê±°ë¶€', 'en': 'Reject', 'vn': 'Tá»« chá»‘i'},
    'submit': {'ko': 'ì œì¶œ', 'en': 'Submit', 'vn': 'Gá»­i'},
    'reset': {'ko': 'ìž¬ì„¤ì •', 'en': 'Reset', 'vn': 'Äáº·t láº¡i'},
    'refresh': {'ko': 'ìƒˆë¡œê³ ì¹¨', 'en': 'Refresh', 'vn': 'LÃ m má»›i'},
    
    # Status
    'active': {'ko': 'í™œì„±', 'en': 'Active', 'vn': 'Hoáº¡t Ä‘á»™ng'},
    'inactive': {'ko': 'ë¹„í™œì„±', 'en': 'Inactive', 'vn': 'KhÃ´ng hoáº¡t Ä‘á»™ng'},
    'pending': {'ko': 'ëŒ€ê¸°ì¤‘', 'en': 'Pending', 'vn': 'Äang chá»'},
    'approved': {'ko': 'ìŠ¹ì¸ë¨', 'en': 'Approved', 'vn': 'ÄÃ£ phÃª duyá»‡t'},
    'rejected': {'ko': 'ê±°ë¶€ë¨', 'en': 'Rejected', 'vn': 'Bá»‹ tá»« chá»‘i'},
    'draft': {'ko': 'ì´ˆì•ˆ', 'en': 'Draft', 'vn': 'Báº£n nhÃ¡p'},
    'sent': {'ko': 'ì „ì†¡ë¨', 'en': 'Sent', 'vn': 'ÄÃ£ gá»­i'},
    'completed': {'ko': 'ì™„ë£Œë¨', 'en': 'Completed', 'vn': 'HoÃ n thÃ nh'},
    'cancelled': {'ko': 'ì·¨ì†Œë¨', 'en': 'Cancelled', 'vn': 'ÄÃ£ há»§y'},
    
    # Common fields
    'name': {'ko': 'ì´ë¦„', 'en': 'Name', 'vn': 'TÃªn'},
    'description': {'ko': 'ì„¤ëª…', 'en': 'Description', 'vn': 'MÃ´ táº£'},
    'date': {'ko': 'ë‚ ì§œ', 'en': 'Date', 'vn': 'NgÃ y'},
    'time': {'ko': 'ì‹œê°„', 'en': 'Time', 'vn': 'Thá»i gian'},
    'amount': {'ko': 'ê¸ˆì•¡', 'en': 'Amount', 'vn': 'Sá»‘ tiá»n'},
    'quantity': {'ko': 'ìˆ˜ëŸ‰', 'en': 'Quantity', 'vn': 'Sá»‘ lÆ°á»£ng'},
    'price': {'ko': 'ê°€ê²©', 'en': 'Price', 'vn': 'GiÃ¡'},
    'total': {'ko': 'í•©ê³„', 'en': 'Total', 'vn': 'Tá»•ng'},
    'subtotal': {'ko': 'ì†Œê³„', 'en': 'Subtotal', 'vn': 'Táº¡m tÃ­nh'},
    'tax': {'ko': 'ì„¸ê¸ˆ', 'en': 'Tax', 'vn': 'Thuáº¿'},
    'discount': {'ko': 'í• ì¸', 'en': 'Discount', 'vn': 'Giáº£m giÃ¡'},
    'address': {'ko': 'ì£¼ì†Œ', 'en': 'Address', 'vn': 'Äá»‹a chá»‰'},
    'phone': {'ko': 'ì „í™”ë²ˆí˜¸', 'en': 'Phone', 'vn': 'Äiá»‡n thoáº¡i'},
    'email': {'ko': 'ì´ë©”ì¼', 'en': 'Email', 'vn': 'Email'},
    'notes': {'ko': 'ë¹„ê³ ', 'en': 'Notes', 'vn': 'Ghi chÃº'},
    'status': {'ko': 'ìƒíƒœ', 'en': 'Status', 'vn': 'Tráº¡ng thÃ¡i'},
    'type': {'ko': 'ìœ í˜•', 'en': 'Type', 'vn': 'Loáº¡i'},
    'category': {'ko': 'ì¹´í…Œê³ ë¦¬', 'en': 'Category', 'vn': 'Danh má»¥c'},
    'code': {'ko': 'ì½”ë“œ', 'en': 'Code', 'vn': 'MÃ£'},
    'number': {'ko': 'ë²ˆí˜¸', 'en': 'Number', 'vn': 'Sá»‘'},
    
    # Business terms
    'customer': {'ko': 'ê³ ê°', 'en': 'Customer', 'vn': 'KhÃ¡ch hÃ ng'},
    'supplier': {'ko': 'ê³µê¸‰ì—…ì²´', 'en': 'Supplier', 'vn': 'NhÃ  cung cáº¥p'},
    'product': {'ko': 'ì œí’ˆ', 'en': 'Product', 'vn': 'Sáº£n pháº©m'},
    'service': {'ko': 'ì„œë¹„ìŠ¤', 'en': 'Service', 'vn': 'Dá»‹ch vá»¥'},
    'quotation': {'ko': 'ê²¬ì ì„œ', 'en': 'Quotation', 'vn': 'BÃ¡o giÃ¡'},
    'order': {'ko': 'ì£¼ë¬¸', 'en': 'Order', 'vn': 'ÄÆ¡n hÃ ng'},
    'invoice': {'ko': 'ì†¡ìž¥', 'en': 'Invoice', 'vn': 'HÃ³a Ä‘Æ¡n'},
    'purchase': {'ko': 'êµ¬ë§¤', 'en': 'Purchase', 'vn': 'Mua hÃ ng'},
    'sale': {'ko': 'íŒë§¤', 'en': 'Sale', 'vn': 'BÃ¡n hÃ ng'},
    'inventory': {'ko': 'ìž¬ê³ ', 'en': 'Inventory', 'vn': 'Tá»“n kho'},
    'payment': {'ko': 'ê²°ì œ', 'en': 'Payment', 'vn': 'Thanh toÃ¡n'},
    'delivery': {'ko': 'ë°°ì†¡', 'en': 'Delivery', 'vn': 'Giao hÃ ng'},
    
    # Time periods
    'today': {'ko': 'ì˜¤ëŠ˜', 'en': 'Today', 'vn': 'HÃ´m nay'},
    'yesterday': {'ko': 'ì–´ì œ', 'en': 'Yesterday', 'vn': 'HÃ´m qua'},
    'this_week': {'ko': 'ì´ë²ˆ ì£¼', 'en': 'This Week', 'vn': 'Tuáº§n nÃ y'},
    'last_week': {'ko': 'ì§€ë‚œ ì£¼', 'en': 'Last Week', 'vn': 'Tuáº§n trÆ°á»›c'},
    'this_month': {'ko': 'ì´ë²ˆ ë‹¬', 'en': 'This Month', 'vn': 'ThÃ¡ng nÃ y'},
    'last_month': {'ko': 'ì§€ë‚œ ë‹¬', 'en': 'Last Month', 'vn': 'ThÃ¡ng trÆ°á»›c'},
    'this_year': {'ko': 'ì˜¬í•´', 'en': 'This Year', 'vn': 'NÄƒm nay'},
    'last_year': {'ko': 'ìž‘ë…„', 'en': 'Last Year', 'vn': 'NÄƒm ngoÃ¡i'},
    
    # Messages
    'loading': {'ko': 'ë¡œë”© ì¤‘...', 'en': 'Loading...', 'vn': 'Äang táº£i...'},
    'no_data': {'ko': 'ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤', 'en': 'No data available', 'vn': 'KhÃ´ng cÃ³ dá»¯ liá»‡u'},
    'select_option': {'ko': 'ì˜µì…˜ì„ ì„ íƒí•˜ì„¸ìš”', 'en': 'Please select an option', 'vn': 'Vui lÃ²ng chá»n má»™t tÃ¹y chá»n'},
    'required_field': {'ko': 'í•„ìˆ˜ ìž…ë ¥ í•­ëª©ìž…ë‹ˆë‹¤', 'en': 'This field is required', 'vn': 'TrÆ°á»ng nÃ y lÃ  báº¯t buá»™c'},
    'invalid_format': {'ko': 'í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤', 'en': 'Invalid format', 'vn': 'Äá»‹nh dáº¡ng khÃ´ng há»£p lá»‡'},
    'operation_success': {'ko': 'ìž‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤', 'en': 'Operation completed successfully', 'vn': 'Hoáº¡t Ä‘á»™ng hoÃ n thÃ nh thÃ nh cÃ´ng'},
    'operation_failed': {'ko': 'ìž‘ì—…ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'en': 'Operation failed', 'vn': 'Hoáº¡t Ä‘á»™ng tháº¥t báº¡i'},
    'confirm_delete': {'ko': 'ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', 'en': 'Are you sure you want to delete?', 'vn': 'Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a khÃ´ng?'},
    'unsaved_changes': {'ko': 'ì €ìž¥í•˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìžˆìŠµë‹ˆë‹¤', 'en': 'You have unsaved changes', 'vn': 'Báº¡n cÃ³ thay Ä‘á»•i chÆ°a Ä‘Æ°á»£c lÆ°u'},
    
    # Modules
    'user_management': {'ko': 'ì‚¬ìš©ìž ê´€ë¦¬', 'en': 'User Management', 'vn': 'Quáº£n lÃ½ ngÆ°á»i dÃ¹ng'},
    'employee_management': {'ko': 'ì§ì› ê´€ë¦¬', 'en': 'Employee Management', 'vn': 'Quáº£n lÃ½ nhÃ¢n viÃªn'},
    'product_management': {'ko': 'ì œí’ˆ ê´€ë¦¬', 'en': 'Product Management', 'vn': 'Quáº£n lÃ½ sáº£n pháº©m'},
    'customer_management': {'ko': 'ê³ ê° ê´€ë¦¬', 'en': 'Customer Management', 'vn': 'Quáº£n lÃ½ khÃ¡ch hÃ ng'},
    'quotation_management': {'ko': 'ê²¬ì ì„œ ê´€ë¦¬', 'en': 'Quotation Management', 'vn': 'Quáº£n lÃ½ bÃ¡o giÃ¡'},
    'purchase_management': {'ko': 'êµ¬ë§¤ ê´€ë¦¬', 'en': 'Purchase Management', 'vn': 'Quáº£n lÃ½ mua hÃ ng'},
    'cash_flow_management': {'ko': 'í˜„ê¸ˆ íë¦„ ê´€ë¦¬', 'en': 'Cash Flow Management', 'vn': 'Quáº£n lÃ½ dÃ²ng tiá»n'},
    'exchange_rate_management': {'ko': 'í™˜ìœ¨ ê´€ë¦¬', 'en': 'Exchange Rate Management', 'vn': 'Quáº£n lÃ½ tá»· giÃ¡'},
    'company_info_management': {'ko': 'íšŒì‚¬ ì •ë³´ ê´€ë¦¬', 'en': 'Company Info Management', 'vn': 'Quáº£n lÃ½ thÃ´ng tin cÃ´ng ty'},
    'report_management': {'ko': 'ë¦¬í¬íŠ¸ ê´€ë¦¬', 'en': 'Report Management', 'vn': 'Quáº£n lÃ½ bÃ¡o cÃ¡o'},
    'settings': {'ko': 'ì„¤ì •', 'en': 'Settings', 'vn': 'CÃ i Ä‘áº·t'},
}

def initialize_translations():
    """Initialize common translations in database"""
    add_translations(COMMON_TRANSLATIONS)

# Business-specific translations
BUSINESS_TRANSLATIONS = {
    # Office supplies categories
    'office_supplies': {'ko': 'ì‚¬ë¬´ìš©í’ˆ', 'en': 'Office Supplies', 'vn': 'VÄƒn phÃ²ng pháº©m'},
    'field_equipment': {'ko': 'í˜„ìž¥ìš©í’ˆ', 'en': 'Field Equipment', 'vn': 'Thiáº¿t bá»‹ hiá»‡n trÆ°á»ng'},
    'other_items': {'ko': 'ê¸°íƒ€', 'en': 'Other Items', 'vn': 'Má»¥c khÃ¡c'},
    
    # Payment terms
    'payment_terms': {'ko': 'ê²°ì œ ì¡°ê±´', 'en': 'Payment Terms', 'vn': 'Äiá»u kiá»‡n thanh toÃ¡n'},
    'delivery_terms': {'ko': 'ë°°ì†¡ ì¡°ê±´', 'en': 'Delivery Terms', 'vn': 'Äiá»u kiá»‡n giao hÃ ng'},
    'warranty_terms': {'ko': 'ë³´ì¦ ì¡°ê±´', 'en': 'Warranty Terms', 'vn': 'Äiá»u kiá»‡n báº£o hÃ nh'},
    
    # Vietnamese labor law specific terms
    'annual_leave': {'ko': 'ì—°ì°¨íœ´ê°€', 'en': 'Annual Leave', 'vn': 'Nghá»‰ phÃ©p nÄƒm'},
    'sick_leave': {'ko': 'ë³‘ê°€', 'en': 'Sick Leave', 'vn': 'Nghá»‰ á»‘m'},
    'maternity_leave': {'ko': 'ì¶œì‚°íœ´ê°€', 'en': 'Maternity Leave', 'vn': 'Nghá»‰ thai sáº£n'},
    'paternity_leave': {'ko': 'ìœ¡ì•„íœ´ì§', 'en': 'Paternity Leave', 'vn': 'Nghá»‰ chÄƒm con'},
    'personal_leave': {'ko': 'ê°œì¸ íœ´ê°€', 'en': 'Personal Leave', 'vn': 'Nghá»‰ cÃ¡ nhÃ¢n'},
    'bereavement_leave': {'ko': 'ê²½ì¡°ì‚¬ íœ´ê°€', 'en': 'Bereavement Leave', 'vn': 'Nghá»‰ tang lá»…'},
    
    # Currency
    'usd': {'ko': 'ë¯¸êµ­ ë‹¬ëŸ¬', 'en': 'US Dollar', 'vn': 'ÄÃ´ la Má»¹'},
    'vnd': {'ko': 'ë² íŠ¸ë‚¨ ë™', 'en': 'Vietnamese Dong', 'vn': 'Äá»“ng Viá»‡t Nam'},
    'krw': {'ko': 'í•œêµ­ ì›', 'en': 'Korean Won', 'vn': 'Won HÃ n Quá»‘c'},
    'cny': {'ko': 'ì¤‘êµ­ ìœ„ì•ˆ', 'en': 'Chinese Yuan', 'vn': 'NhÃ¢n dÃ¢n tá»‡'},
    'thb': {'ko': 'íƒœêµ­ ë°”íŠ¸', 'en': 'Thai Baht', 'vn': 'Baht ThÃ¡i'},
}

def initialize_business_translations():
    """Initialize business-specific translations"""
    add_translations(BUSINESS_TRANSLATIONS)

# Helper function for formatted messages
def t_format(key: str, **kwargs) -> str:
    """Translate key with format parameters"""
    translated = t(key)
    try:
        return translated.format(**kwargs)
    except (KeyError, ValueError):
        return translated